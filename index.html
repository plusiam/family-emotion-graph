âº <!DOCTYPE html>
  <html lang="ko">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
      <title>ë‚˜ì™€ ê°€ì¡±ì˜ ê°ì • ê´€ê³„ ê·¸ë˜í”„</title>
      <style>
          body {
              font-family: 'Malgun Gothic', sans-serif;
              margin: 0;
              padding: 20px;
              background-color: #f5f5f5;
          }

          .worksheet {
              max-width: 1000px;
              margin: 0 auto;
              background: white;
              padding: 30px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }

          h1 {
              text-align: center;
              color: #2c3e50;
              margin-bottom: 10px;
              font-size: 28px;
          }

          .subtitle {
              text-align: center;
              color: #7f8c8d;
              margin-bottom: 30px;
              font-size: 16px;
          }

          .info-section {
              display: flex;
              justify-content: space-between;
              margin-bottom: 30px;
              padding: 15px;
              background-color: #f8f9fa;
              border-radius: 8px;
              flex-wrap: wrap;
              gap: 15px;
          }

          .info-item {
              display: flex;
              align-items: center;
              gap: 10px;
              flex: 1;
              min-width: 200px;
          }

          .info-item label {
              font-weight: bold;
              color: #2c3e50;
          }

          .info-item input {
              border: none;
              border-bottom: 2px solid #3498db;
              padding: 5px;
              font-size: 16px;
              background: transparent;
              flex: 1;
          }

          /* ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì˜ì—­ */
          .save-load-section {
              display: flex;
              gap: 10px;
              margin-bottom: 20px;
              padding: 15px;
              background: #e3f2fd;
              border-radius: 8px;
              flex-wrap: wrap;
          }

          .btn-save, .btn-load, .btn-new, .btn-download {
              padding: 10px 20px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
              transition: all 0.3s ease;
              font-weight: bold;
          }

          .btn-save {
              background: #2196F3;
              color: white;
          }

          .btn-save:hover {
              background: #1976D2;
          }

          .btn-load {
              background: #FF9800;
              color: white;
          }

          .btn-load:hover {
              background: #F57C00;
          }

          .btn-new {
              background: #9C27B0;
              color: white;
          }

          .btn-new:hover {
              background: #7B1FA2;
          }

          .btn-download {
              background: #4CAF50;
              color: white;
          }

          .btn-download:hover {
              background: #388E3C;
          }

          /* ì €ì¥ëœ ëª©ë¡ ëª¨ë‹¬ */
          .modal {
              display: none;
              position: fixed;
              z-index: 1000;
              left: 0;
              top: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0,0,0,0.5);
          }

          .modal-content {
              background-color: white;
              margin: 10% auto;
              padding: 20px;
              border: 1px solid #888;
              width: 90%;
              max-width: 500px;
              border-radius: 10px;
              max-height: 70vh;
              overflow-y: auto;
          }

          .close {
              color: #aaa;
              float: right;
              font-size: 28px;
              font-weight: bold;
              cursor: pointer;
          }

          .close:hover {
              color: black;
          }

          .saved-item {
              padding: 15px;
              margin: 10px 0;
              background: #f8f9fa;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              justify-content: space-between;
              align-items: center;
          }

          .saved-item:hover {
              background: #e9ecef;
              transform: translateX(5px);
          }

          .saved-item-info {
              flex: 1;
          }

          .saved-item-title {
              font-weight: bold;
              color: #2c3e50;
              margin-bottom: 5px;
          }

          .saved-item-date {
              font-size: 12px;
              color: #7f8c8d;
          }

          .delete-saved {
              background: #e74c3c;
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 12px;
          }

          .delete-saved:hover {
              background: #c0392b;
          }

          .controls {
              display: flex;
              gap: 20px;
              margin-bottom: 20px;
              padding: 15px;
              background: #ecf0f1;
              border-radius: 8px;
              flex-wrap: wrap;
              align-items: center;
          }

          .control-group {
              display: flex;
              align-items: center;
              gap: 10px;
          }

          button {
              padding: 8px 16px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
              transition: all 0.3s ease;
          }

          .btn-add {
              background: #27ae60;
              color: white;
          }

          .btn-add:hover {
              background: #229954;
          }

          .btn-clear {
              background: #e74c3c;
              color: white;
          }

          .btn-clear:hover {
              background: #c0392b;
          }

          .line-controls {
              display: flex;
              gap: 10px;
              align-items: center;
          }

          .line-type {
              padding: 5px 10px;
              border: 2px solid #95a5a6;
              background: white;
              cursor: pointer;
              border-radius: 5px;
          }

          .line-type.active {
              background: #34495e;
              color: white;
              border-color: #34495e;
          }

          .color-type {
              padding: 5px 10px;
              border: 2px solid #95a5a6;
              cursor: pointer;
              border-radius: 5px;
              color: white;
          }

          .color-type.blue {
              background: #3498db;
              border-color: #3498db;
          }

          .color-type.red {
              background: #e74c3c;
              border-color: #e74c3c;
          }

          .color-type.active {
              box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
          }

          .graph-container {
              position: relative;
              width: 100%;
              height: 600px;
              border: 3px solid #ecf0f1;
              border-radius: 15px;
              background: white;
              margin-bottom: 30px;
              overflow: hidden;
              touch-action: none;
          }

          svg {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
          }

          svg line {
              cursor: pointer;
              transition: stroke-width 0.3s ease;
          }

          svg line:hover {
              opacity: 0.8;
          }

          .center-circle {
              position: absolute;
              width: 80px;
              height: 80px;
              background: #3498db;
              border-radius: 50%;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-weight: bold;
              font-size: 24px;
              z-index: 10;
              box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
              pointer-events: none;
          }

          .family-member {
              position: absolute;
              width: 70px;
              height: 70px;
              border: 3px solid #95a5a6;
              border-radius: 50%;
              background: white;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
              font-weight: bold;
              color: #2c3e50;
              cursor: pointer;
              transition: all 0.3s ease;
              touch-action: none;
              user-select: none;
          }

          .family-member:hover {
              transform: scale(1.1);
              box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          }

          .family-member.selected {
              border-color: #f39c12;
              background: #fff4e6;
          }

          .family-member.dragging {
              opacity: 0.7;
              z-index: 100;
          }

          .delete-btn {
              position: absolute;
              top: -5px;
              right: -5px;
              width: 20px;
              height: 20px;
              background: #e74c3c;
              color: white;
              border-radius: 50%;
              display: none;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              cursor: pointer;
          }

          .family-member:hover .delete-btn {
              display: flex;
          }

          .thickness-selector {
              position: absolute;
              background: white;
              border: 2px solid #34495e;
              border-radius: 10px;
              padding: 10px;
              box-shadow: 0 5px 20px rgba(0,0,0,0.2);
              display: none;
              z-index: 100;
          }

          .thickness-selector h4 {
              margin: 0 0 10px 0;
              color: #34495e;
              font-size: 14px;
          }

          .thickness-options {
              display: flex;
              gap: 10px;
          }

          .thickness-option {
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              border: 2px solid #ecf0f1;
              border-radius: 5px;
              transition: all 0.3s ease;
          }

          .thickness-option:hover {
              background: #ecf0f1;
              transform: scale(1.1);
          }

          .thickness-option div {
              background: #34495e;
              border-radius: 2px;
              width: 30px;
          }

          .legend {
              background: #ecf0f1;
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 30px;
          }

          .legend h3 {
              margin-top: 0;
              color: #2c3e50;
              font-size: 18px;
              margin-bottom: 15px;
          }

          .legend-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 20px;
          }

          .legend-item {
              display: flex;
              align-items: center;
              gap: 10px;
          }

          .line-sample {
              width: 50px;
              height: 4px;
              border-radius: 2px;
          }

          .thick { height: 6px; }
          .thin { height: 2px; }
          .red { background-color: #e74c3c; }
          .blue { background-color: #3498db; }

          .instruction-box {
              background: #fff4e6;
              border: 2px solid #f39c12;
              border-radius: 10px;
              padding: 20px;
              margin-bottom: 30px;
          }

          .instruction-box h3 {
              color: #d68910;
              margin-top: 0;
              font-size: 18px;
          }

          .instruction-box ol {
              margin: 10px 0;
              padding-left: 25px;
              line-height: 1.8;
          }

          .reflection-section {
              background: #e8f5e9;
              border-radius: 10px;
              padding: 25px;
          }

          .reflection-section h3 {
              color: #2e7d32;
              margin-bottom: 20px;
              font-size: 18px;
          }

          .reflection-question {
              margin-bottom: 20px;
          }

          .reflection-question label {
              display: block;
              color: #1b5e20;
              font-weight: bold;
              margin-bottom: 10px;
          }

          .reflection-question textarea {
              width: 100%;
              min-height: 80px;
              padding: 10px;
              border: 2px solid #81c784;
              border-radius: 5px;
              font-size: 14px;
              resize: vertical;
              box-sizing: border-box;
          }

          /* ìë™ ì €ì¥ í‘œì‹œ */
          .auto-save-indicator {
              position: fixed;
              bottom: 20px;
              right: 20px;
              background: #4CAF50;
              color: white;
              padding: 10px 20px;
              border-radius: 5px;
              opacity: 0;
              transition: opacity 0.3s ease;
              z-index: 1000;
              font-size: 14px;
          }

          .auto-save-indicator.show {
              opacity: 1;
          }

          /* ëª¨ë°”ì¼ ëŒ€ì‘ */
          @media (max-width: 768px) {
              body {
                  padding: 10px;
              }

              .worksheet {
                  padding: 15px;
              }

              h1 {
                  font-size: 22px;
              }

              .info-section {
                  flex-direction: column;
              }

              .info-item {
                  min-width: auto;
              }

              .controls {
                  flex-direction: column;
                  align-items: stretch;
              }

              .control-group, .line-controls {
                  flex-wrap: wrap;
                  justify-content: center;
              }

              .graph-container {
                  height: 400px;
              }

              .family-member {
                  width: 60px;
                  height: 60px;
                  font-size: 12px;
              }

              .center-circle {
                  width: 70px;
                  height: 70px;
                  font-size: 20px;
              }

              .legend-grid {
                  grid-template-columns: 1fr;
                  gap: 10px;
              }

              .save-load-section {
                  justify-content: center;
              }

              .save-load-section button {
                  flex: 1;
                  min-width: 120px;
              }

              /* ëª¨ë°”ì¼ì—ì„œ ë‘êº¼ìš´ ì„ íƒ ë²„íŠ¼ */
              .thickness-selector {
                  left: 50% !important;
                  transform: translateX(-50%);
              }
          }

          @media print {
              .controls, .save-load-section {
                  display: none;
              }
              .thickness-selector {
                  display: none !important;
              }
              .auto-save-indicator {
                  display: none;
              }
          }
      </style>
  </head>
  <body>
      <div class="worksheet">
          <h1>ë‚˜ì™€ ê°€ì¡±ì˜ ê°ì • ê´€ê³„ ê·¸ë˜í”„</h1>
          <p class="subtitle">ìš°ë¦¬ ê°€ì¡±ê³¼ ë‚˜ëŠ” ì–´ë–¤ ê°ì •ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆì„ê¹Œìš”?</p>

          <div class="info-section">
              <div class="info-item">
                  <label>ì´ë¦„:</label>
                  <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì¨ì£¼ì„¸ìš”">
              </div>
              <div class="info-item">
                  <label>ë‚ ì§œ:</label>
                  <input type="text" id="userDate" placeholder="____ë…„ __ì›” __ì¼">
              </div>
              <div class="info-item">
                  <label>ì˜¤ëŠ˜ì˜ ê°ì • ë‚ ì”¨:</label>
                  <input type="text" id="userMood" placeholder="â˜€ï¸ â›… ğŸŒ§ï¸ â›ˆï¸">
              </div>
          </div>

          <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì„¹ì…˜ -->
          <div class="save-load-section">
              <button class="btn-save" onclick="saveToLocal()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
              <button class="btn-load" onclick="showLoadModal()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn-new" onclick="createNew()">ğŸ†• ìƒˆë¡œ ë§Œë“¤ê¸°</button>
              <button class="btn-download" onclick="downloadAsImage()">ğŸ“¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
          </div>

          <!-- ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ -->
          <div id="loadModal" class="modal">
              <div class="modal-content">
                  <span class="close" onclick="closeLoadModal()">&times;</span>
                  <h3>ì €ì¥ëœ ê·¸ë˜í”„ ëª©ë¡</h3>
                  <div id="savedList"></div>
              </div>
          </div>

          <div class="instruction-box">
              <h3>ğŸ“ í™œë™ ë°©ë²•</h3>
              <ol>
                  <li>'ê°€ì¡± ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ê°€ì¡± êµ¬ì„±ì›ì„ ì¶”ê°€í•˜ì„¸ìš”.</li>
                  <li>ì„ ì˜ êµµê¸°(êµµì€ ì„ /ì–‡ì€ ì„ )ì™€ ìƒ‰ê¹”(íŒŒë‘/ë¹¨ê°•)ì„ ì„ íƒí•˜ì„¸ìš”.</li>
                  <li>ê°€ì¡± êµ¬ì„±ì›ì„ í´ë¦­í•˜ë©´ ë‚˜ì™€ ì—°ê²°ì„ ì´ ê·¸ë ¤ì§‘ë‹ˆë‹¤.</li>
                  <li><strong>ê·¸ë ¤ì§„ ì„ ì„ í´ë¦­í•˜ë©´ êµµê¸°ë¥¼ 5ë‹¨ê³„ë¡œ ì„¸ë°€í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></li>
                  <li><strong>ëª¨ë°”ì¼: ê°€ì¡± êµ¬ì„±ì›ì„ ê¸¸ê²Œ ëˆ„ë¥´ê³  ë“œë˜ê·¸í•´ì„œ ìœ„ì¹˜ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong></li>
                  <li>ê°€ì¡± êµ¬ì„±ì›ì„ ì‚­ì œí•˜ë ¤ë©´ ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë†“ê³  X ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</li>
                  <li><strong>ìë™ ì €ì¥: ë³€ê²½ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</strong></li>
              </ol>
          </div>

          <div class="controls">
              <div class="control-group">
                  <button class="btn-add" onclick="addFamilyMember()">â• ê°€ì¡± ì¶”ê°€</button>
                  <button class="btn-clear" onclick="clearAllLines()">ğŸ—‘ï¸ ì„  ëª¨ë‘ ì§€ìš°ê¸°</button>
              </div>
              <div class="line-controls">
                  <span>ì„  êµµê¸°:</span>
                  <button class="line-type active" onclick="setLineThickness('thick')">êµµì€ ì„ </button>
                  <button class="line-type" onclick="setLineThickness('thin')">ì–‡ì€ ì„ </button>
              </div>
              <div class="line-controls">
                  <span>ì„  ìƒ‰ê¹”:</span>
                  <button class="color-type blue active" onclick="setLineColor('blue')">ê¸ì •ì </button>
                  <button class="color-type red" onclick="setLineColor('red')">ë¶€ì •ì </button>
              </div>
          </div>

          <div class="legend">
              <h3>ğŸ“Š ì„  ê·¸ë¦¬ê¸° ì•ˆë‚´</h3>
              <div class="legend-grid">
                  <div class="legend-item">
                      <div class="line-sample thick blue"></div>
                      <span>ê°ì • êµë¥˜ ë§ìŒ + ê¸ì •ì  (íŒŒë‘)</span>
                  </div>
                  <div class="legend-item">
                      <div class="line-sample thick red"></div>
                      <span>ê°ì • êµë¥˜ ë§ìŒ + ë¶€ì •ì  (ë¹¨ê°•)</span>
                  </div>
                  <div class="legend-item">
                      <div class="line-sample thin blue"></div>
                      <span>ê°ì • êµë¥˜ ì ìŒ + ê¸ì •ì  (íŒŒë‘)</span>
                  </div>
                  <div class="legend-item">
                      <div class="line-sample thin red"></div>
                      <span>ê°ì • êµë¥˜ ì ìŒ + ë¶€ì •ì  (ë¹¨ê°•)</span>
                  </div>
              </div>
              <p style="margin-top: 15px; color: #7f8c8d; font-size: 14px;">
                  ğŸ’¡ Tip: ì„ ì„ ê·¸ë¦° í›„ í´ë¦­í•˜ë©´ êµµê¸°ë¥¼ 1-5ë‹¨ê³„ë¡œ ì„¸ë°€í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆì–´ìš”!
              </p>
          </div>

          <div class="graph-container" id="graphContainer">
              <svg id="linesSvg"></svg>
              <div class="center-circle" id="center">ë‚˜</div>
              <div class="thickness-selector" id="thicknessSelector">
                  <h4>ì„  êµµê¸° ì„ íƒ (1-5)</h4>
                  <div class="thickness-options">
                      <div class="thickness-option" onclick="updateLineThickness(2)">
                          <div style="height: 2px;">1</div>
                      </div>
                      <div class="thickness-option" onclick="updateLineThickness(4)">
                          <div style="height: 4px;">2</div>
                      </div>
                      <div class="thickness-option" onclick="updateLineThickness(6)">
                          <div style="height: 6px;">3</div>
                      </div>
                      <div class="thickness-option" onclick="updateLineThickness(8)">
                          <div style="height: 8px;">4</div>
                      </div>
                      <div class="thickness-option" onclick="updateLineThickness(10)">
                          <div style="height: 10px;">5</div>
                      </div>
                  </div>
              </div>
          </div>

          <div class="reflection-section">
              <h3>ğŸ¤” ìƒê°í•´ë³´ê¸°</h3>

              <div class="reflection-question">
                  <label>1. ê°€ì¥ ë‘êº¼ìš´ ì„ ìœ¼ë¡œ ì—°ê²°ëœ ê°€ì¡±ì€ ëˆ„êµ¬ì¸ê°€ìš”? ì™œ ê·¸ëŸ´ê¹Œìš”?</label>
                  <textarea id="reflection1" placeholder="ì˜ˆ: ì—„ë§ˆì™€ ê°€ì¥ ë‘êº¼ìš´ ì„ ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆì–´ìš”. ì™œëƒí•˜ë©´..."></textarea>
              </div>

              <div class="reflection-question">
                  <label>2. ë¹¨ê°„ìƒ‰ ì„ ì´ ìˆë‹¤ë©´, ì–´ë–»ê²Œ í•˜ë©´ íŒŒë€ìƒ‰ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆì„ê¹Œìš”?</label>
                  <textarea id="reflection2" placeholder="ì˜ˆ: ë™ìƒê³¼ ë¹¨ê°„ ì„ ì¸ë°, ì„œë¡œ ì´í•´í•˜ë ¤ê³  ë…¸ë ¥í•˜ë©´..."></textarea>
              </div>

              <div class="reflection-question">
                  <label>3. ì–‡ì€ ì„ ìœ¼ë¡œ ì—°ê²°ëœ ê°€ì¡±ê³¼ ë” ê°€ê¹Œì›Œì§€ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?</label>
                  <textarea id="reflection3" placeholder="ì˜ˆ: ì•„ë¹ ì™€ ëŒ€í™”ë¥¼ ë” ë§ì´ ë‚˜ëˆ„ë©´..."></textarea>
              </div>

              <div class="reflection-question">
                  <label>4. ì˜¤ëŠ˜ ë‚˜ì˜ ê°ì •ì´ ê°€ì¡±ì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì£¼ì—ˆë‚˜ìš”?</label>
                  <textarea id="reflection4" placeholder="ì˜ˆ: ë‚´ê°€ ê¸°ë¶„ì´ ì¢‹ìœ¼ë‹ˆê¹Œ ë™ìƒë„ ê¸°ë¶„ì´ ì¢‹ì•„ ë³´ì˜€ì–´ìš”..."></textarea>
              </div>
          </div>
      </div>

      <!-- ìë™ ì €ì¥ í‘œì‹œ -->
      <div class="auto-save-indicator" id="autoSaveIndicator">
          âœ… ìë™ ì €ì¥ë¨
      </div>

      <script>
          let currentThickness = 'thick';
          let currentColor = 'blue';
          let familyMembers = [];
          let lines = [];
          let memberCount = 0;
          let selectedLine = null;
          let autoSaveTimeout = null;
          let isDragging = false;
          let draggedMember = null;
          let dragOffset = { x: 0, y: 0 };

          // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
          window.addEventListener('load', () => {
              loadAutoSave();
          });

          // localStorage í‚¤
          const STORAGE_KEY = 'family_emotion_graphs';
          const AUTOSAVE_KEY = 'family_emotion_autosave';

          function setLineThickness(thickness) {
              currentThickness = thickness;
              document.querySelectorAll('.line-type').forEach(btn => btn.classList.remove('active'));
              event.target.classList.add('active');
          }

          function setLineColor(color) {
              currentColor = color;
              document.querySelectorAll('.color-type').forEach(btn => btn.classList.remove('active'));
              event.target.classList.add('active');
          }

          function addFamilyMember() {
              const name = prompt('ê°€ì¡± êµ¬ì„±ì›ì˜ ì´ë¦„ì´ë‚˜ í˜¸ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”:');
              if (!name) return;

              const container = document.getElementById('graphContainer');
              const member = document.createElement('div');
              member.className = 'family-member';
              member.innerHTML = `${name}<div class="delete-btn" onclick="deleteFamilyMember(event, this.parentElement)">Ã—</div>`;
              member.id = `member-${memberCount++}`;

              // ì›í˜•ìœ¼ë¡œ ë°°ì¹˜
              const angle = (familyMembers.length * 60) * Math.PI / 180;
              const radius = 200;
              const centerX = container.offsetWidth / 2;
              const centerY = container.offsetHeight / 2;

              member.style.left = (centerX + radius * Math.cos(angle) - 35) + 'px';
              member.style.top = (centerY + radius * Math.sin(angle) - 35) + 'px';

              // í´ë¦­ ì´ë²¤íŠ¸
              member.onclick = function(e) {
                  if (e.target.className === 'delete-btn') return;
                  if (!isDragging) {
                      drawLine(this);
                  }
              };

              // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ê³µí†µ)
              setupDragEvents(member);

              container.appendChild(member);
              familyMembers.push(member);

              // ìë™ ì €ì¥
              autoSave();
          }

          function setupDragEvents(member) {
              let startX, startY, initialLeft, initialTop;
              let longPressTimer;
              let hasMoved = false;

              // í„°ì¹˜ ì´ë²¤íŠ¸
              member.addEventListener('touchstart', (e) => {
                  e.preventDefault();
                  const touch = e.touches[0];
                  startX = touch.clientX;
                  startY = touch.clientY;
                  initialLeft = member.offsetLeft;
                  initialTop = member.offsetTop;
                  hasMoved = false;

                  // ê¸¸ê²Œ ëˆ„ë¥´ê¸° ê°ì§€
                  longPressTimer = setTimeout(() => {
                      member.classList.add('dragging');
                      isDragging = true;
                      draggedMember = member;
                  }, 300);
              });

              member.addEventListener('touchmove', (e) => {
                  e.preventDefault();
                  const touch = e.touches[0];
                  const deltaX = touch.clientX - startX;
                  const deltaY = touch.clientY - startY;

                  // ì›€ì§ì„ ê°ì§€
                  if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                      hasMoved = true;
                      clearTimeout(longPressTimer);

                      if (isDragging && draggedMember === member) {
                          member.style.left = (initialLeft + deltaX) + 'px';
                          member.style.top = (initialTop + deltaY) + 'px';
                          updateConnectedLines(member);
                      }
                  }
              });

              member.addEventListener('touchend', (e) => {
                  e.preventDefault();
                  clearTimeout(longPressTimer);

                  if (isDragging && draggedMember === member) {
                      member.classList.remove('dragging');
                      isDragging = false;
                      draggedMember = null;
                      autoSave();
                  } else if (!hasMoved) {
                      // ì§§ì€ íƒ­ = ì„  ê·¸ë¦¬ê¸°
                      drawLine(member);
                  }
              });

              // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†±)
              member.addEventListener('mousedown', (e) => {
                  if (e.target.className === 'delete-btn') return;
                  e.preventDefault();
                  startX = e.clientX;
                  startY = e.clientY;
                  initialLeft = member.offsetLeft;
                  initialTop = member.offsetTop;
                  member.classList.add('dragging');
                  isDragging = true;
                  draggedMember = member;
              });
          }

          // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
          document.addEventListener('mousemove', (e) => {
              if (isDragging && draggedMember) {
                  const container = document.getElementById('graphContainer');
                  const rect = container.getBoundingClientRect();
                  let newLeft = e.clientX - rect.left - 35;
                  let newTop = e.clientY - rect.top - 35;

                  // ì»¨í…Œì´ë„ˆ ê²½ê³„ ì²´í¬
                  newLeft = Math.max(0, Math.min(newLeft, container.offsetWidth - 70));
                  newTop = Math.max(0, Math.min(newTop, container.offsetHeight - 70));

                  draggedMember.style.left = newLeft + 'px';
                  draggedMember.style.top = newTop + 'px';

                  updateConnectedLines(draggedMember);
              }
          });

          document.addEventListener('mouseup', () => {
              if (isDragging && draggedMember) {
                  draggedMember.classList.remove('dragging');
                  isDragging = false;
                  draggedMember = null;
                  autoSave();
              }
          });

          function updateConnectedLines(member) {
              const memberId = member.id;
              const svg = document.getElementById('linesSvg');
              const center = document.getElementById('center');
              const container = document.getElementById('graphContainer');

              const centerRect = center.getBoundingClientRect();
              const memberRect = member.getBoundingClientRect();
              const containerRect = container.getBoundingClientRect();

              const x1 = centerRect.left + centerRect.width / 2 - containerRect.left;
              const y1 = centerRect.top + centerRect.height / 2 - containerRect.top;
              const x2 = memberRect.left + memberRect.width / 2 - containerRect.left;
              const y2 = memberRect.top + memberRect.height / 2 - containerRect.top;

              // í•´ë‹¹ ë©¤ë²„ì˜ ì„  ì—…ë°ì´íŠ¸
              lines.forEach(line => {
                  if (line.memberId === memberId) {
                      line.element.setAttribute('x2', x2);
                      line.element.setAttribute('y2', y2);
                  }
              });
          }

          function deleteFamilyMember(event, member) {
              event.stopPropagation();
              const memberId = member.id;

              // í•´ë‹¹ ë©¤ë²„ì™€ ì—°ê²°ëœ ì„  ì‚­ì œ
              lines = lines.filter(line => {
                  if (line.memberId === memberId) {
                      line.element.remove();
                      return false;
                  }
                  return true;
              });

              // ë©¤ë²„ ì‚­ì œ
              member.remove();
              familyMembers = familyMembers.filter(m => m.id !== memberId);

              // ìë™ ì €ì¥
              autoSave();
          }

          function drawLine(member) {
              const memberId = member.id;

              // ì´ë¯¸ ì—°ê²°ëœ ì„ ì´ ìˆëŠ”ì§€ í™•ì¸
              const existingLineIndex = lines.findIndex(line => line.memberId === memberId);
              if (existingLineIndex !== -1) {
                  // ê¸°ì¡´ ì„  ì‚­ì œ
                  lines[existingLineIndex].element.remove();
                  lines.splice(existingLineIndex, 1);
              }

              const svg = document.getElementById('linesSvg');
              const center = document.getElementById('center');
              const container = document.getElementById('graphContainer');

              const centerRect = center.getBoundingClientRect();
              const memberRect = member.getBoundingClientRect();
              const containerRect = container.getBoundingClientRect();

              const x1 = centerRect.left + centerRect.width / 2 - containerRect.left;
              const y1 = centerRect.top + centerRect.height / 2 - containerRect.top;
              const x2 = memberRect.left + memberRect.width / 2 - containerRect.left;
              const y2 = memberRect.top + memberRect.height / 2 - containerRect.top;

              const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
              line.setAttribute('x1', x1);
              line.setAttribute('y1', y1);
              line.setAttribute('x2', x2);
              line.setAttribute('y2', y2);

              // ì„  ìŠ¤íƒ€ì¼ ì„¤ì •
              const strokeWidth = currentThickness === 'thick' ? '6' : '2';
              const strokeColor = currentColor === 'blue' ? '#3498db' : '#e74c3c';

              line.setAttribute('stroke', strokeColor);
              line.setAttribute('stroke-width', strokeWidth);

              // ì„  í´ë¦­ ì´ë²¤íŠ¸
              line.onclick = function(e) {
                  e.stopPropagation();
                  showThicknessSelector(e, line);
              };

              svg.appendChild(line);
              lines.push({
                  element: line,
                  memberId: memberId,
                  thickness: strokeWidth,
                  color: currentColor
              });

              // ì„ íƒ í‘œì‹œ
              document.querySelectorAll('.family-member').forEach(m => m.classList.remove('selected'));
              member.classList.add('selected');
              setTimeout(() => member.classList.remove('selected'), 1000);

              // ìë™ ì €ì¥
              autoSave();
          }

          function showThicknessSelector(event, line) {
              selectedLine = line;
              const selector = document.getElementById('thicknessSelector');
              const container = document.getElementById('graphContainer');
              const containerRect = container.getBoundingClientRect();

              // ì„ íƒê¸° ìœ„ì¹˜ ì„¤ì •
              selector.style.left = (event.clientX - containerRect.left - 100) + 'px';
              selector.style.top = (event.clientY - containerRect.top - 60) + 'px';
              selector.style.display = 'block';

              // í´ë¦­ ì™¸ë¶€ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
              setTimeout(() => {
                  document.addEventListener('click', hideThicknessSelector);
              }, 100);
          }

          function hideThicknessSelector() {
              document.getElementById('thicknessSelector').style.display = 'none';
              document.removeEventListener('click', hideThicknessSelector);
          }

          function updateLineThickness(thickness) {
              if (selectedLine) {
                  selectedLine.setAttribute('stroke-width', thickness);

                  // lines ë°°ì—´ì—ì„œë„ ì—…ë°ì´íŠ¸
                  const lineData = lines.find(l => l.element === selectedLine);
                  if (lineData) {
                      lineData.thickness = thickness;
                  }

                  // ìë™ ì €ì¥
                  autoSave();
              }
              hideThicknessSelector();
          }

          function clearAllLines() {
              if (confirm('ëª¨ë“  ì—°ê²°ì„ ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  const svg = document.getElementById('linesSvg');
                  svg.innerHTML = '';
                  lines = [];
                  autoSave();
              }
          }

          // ìë™ ì €ì¥ í•¨ìˆ˜
          function autoSave() {
              // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
              if (autoSaveTimeout) {
                  clearTimeout(autoSaveTimeout);
              }

              // 300ms í›„ ì €ì¥
              autoSaveTimeout = setTimeout(() => {
                  const data = collectData();
                  localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
                  showAutoSaveIndicator();
              }, 300);
          }

          function showAutoSaveIndicator() {
              const indicator = document.getElementById('autoSaveIndicator');
              indicator.classList.add('show');
              setTimeout(() => {
                  indicator.classList.remove('show');
              }, 2000);
          }

          // ë°ì´í„° ìˆ˜ì§‘
          function collectData() {
              const data = {
                  userName: document.getElementById('userName').value,
                  userDate: document.getElementById('userDate').value,
                  userMood: document.getElementById('userMood').value,
                  members: familyMembers.map(member => ({
                      id: member.id,
                      name: member.textContent.replace('Ã—', '').trim(),
                      left: member.style.left,
                      top: member.style.top
                  })),
                  lines: lines.map(line => ({
                      memberId: line.memberId,
                      color: line.color,
                      thickness: line.element.getAttribute('stroke-width')
                  })),
                  reflections: {
                      reflection1: document.getElementById('reflection1').value,
                      reflection2: document.getElementById('reflection2').value,
                      reflection3: document.getElementById('reflection3').value,
                      reflection4: document.getElementById('reflection4').value
                  },
                  timestamp: new Date().toISOString()
              };
              return data;
          }

          // ë°ì´í„° ë³µì›
          function restoreData(data) {
              // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
              clearAll();

              // ì •ë³´ ë³µì›
              document.getElementById('userName').value = data.userName || '';
              document.getElementById('userDate').value = data.userDate || '';
              document.getElementById('userMood').value = data.userMood || '';

              // ê°€ì¡± êµ¬ì„±ì› ë³µì›
              const container = document.getElementById('graphContainer');
              data.members.forEach(memberData => {
                  const member = document.createElement('div');
                  member.className = 'family-member';
                  member.innerHTML = `${memberData.name}<div class="delete-btn" onclick="deleteFamilyMember(event, this.parentElement)">Ã—</div>`;
                  member.id = memberData.id;
                  member.style.left = memberData.left;
                  member.style.top = memberData.top;

                  member.onclick = function(e) {
                      if (e.target.className === 'delete-btn') return;
                      if (!isDragging) {
                          drawLine(this);
                      }
                  };

                  setupDragEvents(member);
                  container.appendChild(member);
                  familyMembers.push(member);
              });

              // ì„  ë³µì›
              setTimeout(() => {
                  data.lines.forEach(lineData => {
                      const member = document.getElementById(lineData.memberId);
                      if (member) {
                          currentColor = lineData.color;
                          currentThickness = lineData.thickness > 3 ? 'thick' : 'thin';
                          drawLine(member);
                          // ì„  êµµê¸° ì§ì ‘ ì„¤ì •
                          const lastLine = lines[lines.length - 1];
                          if (lastLine) {
                              lastLine.element.setAttribute('stroke-width', lineData.thickness);
                          }
                      }
                  });

                  // ìƒ‰ìƒê³¼ êµµê¸° ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                  currentColor = 'blue';
                  currentThickness = 'thick';
                  document.querySelectorAll('.color-type').forEach(btn => {
                      btn.classList.toggle('active', btn.onclick.toString().includes(currentColor));
                  });
                  document.querySelectorAll('.line-type').forEach(btn => {
                      btn.classList.toggle('active', btn.onclick.toString().includes(currentThickness));
                  });
              }, 100);

              // ë°˜ì„± ë¬¸í•­ ë³µì›
              if (data.reflections) {
                  document.getElementById('reflection1').value = data.reflections.reflection1 || '';
                  document.getElementById('reflection2').value = data.reflections.reflection2 || '';
                  document.getElementById('reflection3').value = data.reflections.reflection3 || '';
                  document.getElementById('reflection4').value = data.reflections.reflection4 || '';
              }
          }

          // ì €ì¥í•˜ê¸°
          function saveToLocal() {
              const name = document.getElementById('userName').value || 'ì´ë¦„ì—†ìŒ';
              const date = new Date().toLocaleString('ko-KR');
              const saveKey = `${name}_${Date.now()}`;

              const data = collectData();
              data.saveKey = saveKey;
              data.displayName = `${name} - ${date}`;

              // ê¸°ì¡´ ì €ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
              const savedList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              savedList[saveKey] = data;

              localStorage.setItem(STORAGE_KEY, JSON.stringify(savedList));
              alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }

          // ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ í‘œì‹œ
          function showLoadModal() {
              const modal = document.getElementById('loadModal');
              const savedList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              const listContainer = document.getElementById('savedList');

              listContainer.innerHTML = '';

              if (Object.keys(savedList).length === 0) {
                  listContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">ì €ì¥ëœ ê·¸ë˜í”„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
              } else {
                  Object.entries(savedList).reverse().forEach(([key, data]) => {
                      const item = document.createElement('div');
                      item.className = 'saved-item';
                      item.innerHTML = `
                          <div class="saved-item-info" onclick="loadSaved('${key}')">
                              <div class="saved-item-title">${data.displayName}</div>
                              <div class="saved-item-date">${new Date(data.timestamp).toLocaleString('ko-KR')}</div>
                          </div>
                          <button class="delete-saved" onclick="deleteSaved('${key}')">ì‚­ì œ</button>
                      `;
                      listContainer.appendChild(item);
                  });
              }

              modal.style.display = 'block';
          }

          function closeLoadModal() {
              document.getElementById('loadModal').style.display = 'none';
          }

          // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          function loadSaved(key) {
              const savedList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              const data = savedList[key];

              if (data) {
                  restoreData(data);
                  closeLoadModal();
                  alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
              }
          }

          // ì €ì¥ëœ ë°ì´í„° ì‚­ì œ
          function deleteSaved(key) {
              if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  const savedList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                  delete savedList[key];
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(savedList));
                  showLoadModal(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              }
          }

          // ìƒˆë¡œ ë§Œë“¤ê¸°
          function createNew() {
              if (confirm('í˜„ì¬ ì‘ì—…ì„ ëª¨ë‘ ì§€ìš°ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  clearAll();
                  localStorage.removeItem(AUTOSAVE_KEY);
              }
          }

          // ëª¨ë‘ ì§€ìš°ê¸°
          function clearAll() {
              // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
              document.getElementById('userName').value = '';
              document.getElementById('userDate').value = '';
              document.getElementById('userMood').value = '';

              // ê°€ì¡± êµ¬ì„±ì› ì œê±°
              familyMembers.forEach(member => member.remove());
              familyMembers = [];

              // ì„  ì œê±°
              const svg = document.getElementById('linesSvg');
              svg.innerHTML = '';
              lines = [];

              // ë°˜ì„± ë¬¸í•­ ì´ˆê¸°í™”
              document.getElementById('reflection1').value = '';
              document.getElementById('reflection2').value = '';
              document.getElementById('reflection3').value = '';
              document.getElementById('reflection4').value = '';

              memberCount = 0;
          }

          // ìë™ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
          function loadAutoSave() {
              const autoSaveData = localStorage.getItem(AUTOSAVE_KEY);
              if (autoSaveData) {
                  try {
                      const data = JSON.parse(autoSaveData);
                      restoreData(data);
                  } catch (e) {
                      console.error('ìë™ ì €ì¥ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e);
                  }
              }
          }

          // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          function downloadAsImage() {
              // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
              if (!window.html2canvas) {
                  const script = document.createElement('script');
                  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                  script.onload = () => performDownload();
                  document.head.appendChild(script);
              } else {
                  performDownload();
              }
          }

          function performDownload() {
              const worksheet = document.querySelector('.worksheet');
              const userName = document.getElementById('userName').value || 'ê°€ì¡±ê´€ê³„';
              const date = new Date().toLocaleDateString('ko-KR').replace(/\./g, '-');

              html2canvas(worksheet, {
                  scale: 2,
                  backgroundColor: '#ffffff',
                  logging: false
              }).then(canvas => {
                  const link = document.createElement('a');
                  link.download = `${userName}_ê°ì •ê´€ê³„ê·¸ë˜í”„_${date}.png`;
                  link.href = canvas.toDataURL();
                  link.click();
              });
          }

          // ì™¸ë¶€ í´ë¦­ ì‹œ ì„ íƒê¸° ìˆ¨ê¸°ê¸°
          document.getElementById('graphContainer').addEventListener('click', function(e) {
              if (e.target === this || e.target.id === 'linesSvg') {
                  hideThicknessSelector();
              }
          });

          // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
          document.querySelectorAll('input, textarea').forEach(element => {
              element.addEventListener('input', autoSave);
          });

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          window.onclick = function(event) {
              const modal = document.getElementById('loadModal');
              if (event.target == modal) {
                  closeLoadModal();
              }
          }
      </script>
  </body>
  </html>

